<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .admin-panel {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar h2 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .video-container {
            background: #000;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #camera-canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            cursor: crosshair;
            object-fit: contain;
            position: relative;
            z-index: 1;
            touch-action: none;
        }
        
        .video-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            position: relative;
        }
        
        #zones-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º */
        }
        
        .zone-overlay {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
        }
        
        .zone-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
        }
        
        .zones-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .zone-item {
            padding: 10px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .zone-item button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</h1>
        
        <div class="admin-panel">
            <div class="sidebar">
                <div class="instructions">
                    <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
                    <ol>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É</li>
                        <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞–¥—Ä</li>
                        <li><strong>–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏</strong> –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –ø–æ–ª–∏–≥–æ–Ω–∞ –∑–æ–Ω—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</li>
                        <li>–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–æ–Ω—É" –∑–∞–º—ã–∫–∞—é—Ç –ø–æ–ª–∏–≥–æ–Ω</li>
                        <li>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</li>
                        <li>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑–≤–ª–µ–∫—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</li>
                        <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∫—É</li>
                    </ol>
                    <p style="margin-top: 10px; color: #1976d2; font-weight: bold;">
                        üí° –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –ø–æ–ª–∏–≥–æ–Ω–∞. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å" –∑–∞–º—ã–∫–∞—é—Ç –∑–æ–Ω—É.
                    </p>
                    <button class="btn-primary" onclick="finishCurrentZone()" id="finish-zone-btn" style="display: none; width: 100%; margin-top: 10px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–æ–Ω—É</button>
                </div>
                
                <div class="form-group">
                    <label>–ö–∞–º–µ—Ä–∞:</label>
                    <select id="camera-select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
                    </select>
                </div>
                
                <button class="btn-primary" onclick="loadCameraFrame()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–¥—Ä</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:</label>
                    <input type="text" id="stop-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞">
                </div>
                
                <div class="form-group">
                    <label>–®–∏—Ä–æ—Ç–∞:</label>
                    <input type="number" id="latitude" step="0.000001" placeholder="55.1644">
                </div>
                
                <div class="form-group">
                    <label>–î–æ–ª–≥–æ—Ç–∞:</label>
                    <input type="number" id="longitude" step="0.000001" placeholder="61.4368">
                </div>
                
                <div class="form-group">
                    <label>–°—Å—ã–ª–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã:</label>
                    <input type="text" id="yandex-map-url" placeholder="https://yandex.ru/maps/..." onchange="extractCoordinatesFromUrl()">
                    <small style="color: #666;">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –∏–∑–≤–ª–µ—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ URL</small>
                </div>
                
                <div class="zones-list" id="zones-list">
                    <h3>–í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã:</h3>
                    <div id="zones-container"></div>
                </div>
                
                <button class="btn-success" onclick="saveStop()" style="width: 100%; margin-top: 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É</button>
            </div>
            
            <div class="video-container">
                <canvas id="camera-canvas"></canvas>
                <div id="zones-overlay"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let cameras = [];
        let selectedCamera = null;
        let canvas, ctx;
        let isDrawing = false;
        let currentZone = null;
        let zones = [];
        let originalImage = null;
        let drawingMode = 'polygon'; // 'polygon' –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–æ–Ω
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            canvas = document.getElementById('camera-canvas');
            if (!canvas) {
                console.error('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç canvas!');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä canvas
            canvas.width = 800;
            canvas.height = 600;
            canvas.style.width = '100%';
            canvas.style.height = 'auto';
            
            // –†–∏—Å—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞–¥—Ä', canvas.width / 2, canvas.height / 2);
            
            console.log('Canvas –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', canvas.width, 'x', canvas.height);
            loadCameras();
        };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä
        async function loadCameras() {
            try {
                const response = await fetch(`${API_BASE}/cv/cameras`);
                const data = await response.json();
                cameras = data.cameras;
                
                const select = document.getElementById('camera-select');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                cameras.forEach(cam => {
                    const option = document.createElement('option');
                    option.value = cam.id;
                    option.textContent = cam.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–¥—Ä–∞ —Å –∫–∞–º–µ—Ä—ã
        async function loadCameraFrame() {
            const cameraId = document.getElementById('camera-select').value;
            if (!cameraId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É');
                return;
            }
            
            selectedCamera = cameras.find(c => c.id === cameraId);
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                canvas.style.opacity = '0.5';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–ó–∞–≥—Ä—É–∑–∫–∞...', canvas.width / 2 || 200, canvas.height / 2 || 200);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã
                const response = await fetch(`${API_BASE}/cv/camera/${cameraId}/snapshot?with_detection=false`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                
                const img = new Image();
                img.onload = () => {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    originalImage = img;
                    
                    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º canvas –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                    const container = canvas.parentElement;
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight || 600;
                    
                    const imgAspect = img.width / img.height;
                    const containerAspect = containerWidth / containerHeight;
                    
                    let displayWidth, displayHeight;
                    if (imgAspect > containerAspect) {
                        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∏—Ä–µ
                        displayWidth = containerWidth;
                        displayHeight = containerWidth / imgAspect;
                    } else {
                        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—à–µ
                        displayHeight = containerHeight;
                        displayWidth = containerHeight * imgAspect;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    canvas.style.width = displayWidth + 'px';
                    canvas.style.height = displayHeight + 'px';
                    
                    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∞–∑–º–µ—Ä canvas = –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                    ctx = canvas.getContext('2d');
                    
                    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                    canvas.style.opacity = '1';
                    
                    // –û—á–∏—â–∞–µ–º –∑–æ–Ω—ã
                    zones = [];
                    currentZone = null;
                    isDrawing = false;
                    updateZonesDisplay();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.8)';
                    ctx.fillRect(10, 10, 300, 40);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('üí° –ó–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∑–æ–Ω—ã', 15, 35);
                    
                    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (originalImage) {
                            redrawCanvas();
                        }
                    }, 3000);
                    
                    // –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    attachCanvasEvents();
                    
                    console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', canvas.width, 'x', canvas.height);
                    console.log('–†–∞–∑–º–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', displayWidth, 'x', displayHeight);
                    console.log('Canvas –≥–æ—Ç–æ–≤ –∫ —Ä–∏—Å–æ–≤–∞–Ω–∏—é');
                    console.log('Canvas —ç–ª–µ–º–µ–Ω—Ç:', canvas);
                    console.log('Canvas –≤–∏–¥–∏–º—ã–π:', canvas.offsetWidth > 0 && canvas.offsetHeight > 0);
                };
                img.onerror = (error) => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    canvas.style.opacity = '1';
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                };
                img.src = URL.createObjectURL(blob);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–¥—Ä–∞:', error);
                canvas.style.opacity = '1';
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–¥—Ä —Å –∫–∞–º–µ—Ä—ã: ' + error.message);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º—ã—à–∏ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö canvas
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ rect –≤–∞–ª–∏–¥–µ–Ω
            if (rect.width === 0 || rect.height === 0) {
                console.warn('Canvas rect –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä:', rect);
                return { x: 0, y: 0 };
            }
            
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –º—ã—à–∏, —Ç–∞–∫ –∏ touch-—Å–æ–±—ã—Ç–∏–π
            const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
            const clientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
            
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ canvas
            const result = {
                x: Math.max(0, Math.min(x, canvas.width)),
                y: Math.max(0, Math.min(y, canvas.height))
            };
            
            // –û—Ç–ª–∞–¥–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
            if (e.type === 'mousedown') {
                console.log('getCanvasCoordinates:', {
                    clientX, clientY,
                    rect: { left: rect.left, top: rect.top, width: rect.width, height: rect.height },
                    canvasSize: { width: canvas.width, height: canvas.height },
                    scale: { scaleX, scaleY },
                    result
                });
            }
            
            return result;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
        function addPointToPolygon(e) {
            if (!originalImage) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞–¥—Ä —Å –∫–∞–º–µ—Ä—ã!');
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const coords = getCanvasCoordinates(e);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫, –∑–∞–≤–µ—Ä—à–∞–µ–º –∑–æ–Ω—É
            if (e.detail === 2) {
                finishCurrentZone();
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–π –∑–æ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
            if (!currentZone) {
                currentZone = {
                    points: [],
                    name: `–ó–æ–Ω–∞ ${zones.length + 1}`
                };
                isDrawing = true;
                document.getElementById('finish-zone-btn').style.display = 'block';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É
            currentZone.points.push([coords.x, coords.y]);
            console.log('–¢–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:', coords, '–í—Å–µ–≥–æ —Ç–æ—á–µ–∫:', currentZone.points.length);
            
            redrawCanvas();
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–æ–Ω—ã
        function finishCurrentZone() {
            if (!currentZone || currentZone.points.length < 3) {
                if (currentZone && currentZone.points.length < 3) {
                    alert('–ü–æ–ª–∏–≥–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏');
                }
                return;
            }
            
            // –ó–∞–º—ã–∫–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω (–¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É –≤ –∫–æ–Ω–µ—Ü)
            if (currentZone.points.length > 0) {
                const firstPoint = currentZone.points[0];
                const lastPoint = currentZone.points[currentZone.points.length - 1];
                // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–µ—Ä–≤–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
                if (Math.abs(firstPoint[0] - lastPoint[0]) > 1 || Math.abs(firstPoint[1] - lastPoint[1]) > 1) {
                    currentZone.points.push([firstPoint[0], firstPoint[1]]);
                }
            }
            
            zones.push({
                coords: currentZone.points,
                name: currentZone.name
            });
            
            console.log('–ó–æ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', zones[zones.length - 1]);
            
            currentZone = null;
            isDrawing = false;
            document.getElementById('finish-zone-btn').style.display = 'none';
            redrawCanvas();
            updateZonesDisplay();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function drawMove(e) {
            if (!isDrawing || !currentZone) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const coords = getCanvasCoordinates(e);
            redrawCanvas();
            
            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏ –∫ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏
            if (currentZone.points.length > 0) {
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                const lastPoint = currentZone.points[currentZone.points.length - 1];
                ctx.beginPath();
                ctx.moveTo(lastPoint[0], lastPoint[1]);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        function handleDoubleClick(e) {
            e.preventDefault();
            finishCurrentZone();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function attachCanvasEvents() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            canvas.removeEventListener('click', addPointToPolygon);
            canvas.removeEventListener('dblclick', handleDoubleClick);
            canvas.removeEventListener('mousemove', drawMove);
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            canvas.addEventListener('click', addPointToPolygon, { passive: false });
            canvas.addEventListener('dblclick', handleDoubleClick, { passive: false });
            canvas.addEventListener('mousemove', drawMove, { passive: false });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ canvas
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            }, { passive: false });
            
            console.log('–°–æ–±—ã—Ç–∏—è canvas –ø—Ä–∏–≤—è–∑–∞–Ω—ã');
        }
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        attachCanvasEvents();
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ canvas
        function redrawCanvas() {
            if (!originalImage) {
                console.warn('redrawCanvas: –Ω–µ—Ç originalImage');
                return;
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∞–ª–∏–¥–µ–Ω
            if (!ctx) {
                console.warn('redrawCanvas: –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º');
                ctx = canvas.getContext('2d');
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            try {
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                return;
            }
            
            // –†–∏—Å—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
            zones.forEach((zone, index) => {
                drawZone(zone.coords, zone.name, index);
            });
            
            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É (–ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–∏–≥–æ–Ω–∞)
            if (currentZone && currentZone.points) {
                if (currentZone.points.length > 0) {
                    // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
                    ctx.fillStyle = '#667eea';
                    currentZone.points.forEach((point, index) => {
                        ctx.beginPath();
                        ctx.arc(point[0], point[1], 5, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // –ù–æ–º–µ—Ä —Ç–æ—á–∫–∏
                        ctx.fillStyle = 'white';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(index + 1, point[0], point[1] - 8);
                        ctx.fillStyle = '#667eea';
                    });
                    
                    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                    if (currentZone.points.length > 1) {
                        ctx.strokeStyle = '#667eea';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(currentZone.points[0][0], currentZone.points[0][1]);
                        for (let i = 1; i < currentZone.points.length; i++) {
                            ctx.lineTo(currentZone.points[i][0], currentZone.points[i][1]);
                        }
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
            }
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã (–ø–æ–ª–∏–≥–æ–Ω)
        function drawZone(coords, name, index) {
            if (!coords || coords.length < 3) return;
            
            ctx.strokeStyle = '#667eea';
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.lineWidth = 2;
            ctx.setLineDash([]);
            
            ctx.beginPath();
            ctx.moveTo(coords[0][0], coords[0][1]);
            for (let i = 1; i < coords.length; i++) {
                ctx.lineTo(coords[i][0], coords[i][1]);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
            ctx.fillStyle = '#667eea';
            coords.forEach((point, i) => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // –ü–æ–¥–ø–∏—Å—å
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(name, coords[0][0] + 5, coords[0][1] - 5);
        }
        
        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ URL –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
        function extractCoordinatesFromUrl() {
            const url = document.getElementById('yandex-map-url').value;
            if (!url) return;
            
            try {
                // –ü–∞—Ä—Å–∏–º URL –≤–∏–¥–∞: https://yandex.ru/maps/56/chelyabinsk/stops/stop__9900259/?ll=61.441128%2C55.138736&tab=overview&z=18.44
                const urlObj = new URL(url);
                const llParam = urlObj.searchParams.get('ll');
                
                if (llParam) {
                    const [longitude, latitude] = llParam.split(',').map(parseFloat);
                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;
                        console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ URL:', latitude, longitude);
                        return;
                    }
                }
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—É—Ç–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ URL');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–æ–Ω
        function updateZonesDisplay() {
            const container = document.getElementById('zones-container');
            container.innerHTML = zones.map((zone, index) => `
                <div class="zone-item">
                    <span>${zone.name}</span>
                    <button class="btn-danger" onclick="removeZone(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã
        function removeZone(index) {
            zones.splice(index, 1);
            redrawCanvas();
            updateZonesDisplay();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        async function saveStop() {
            const name = document.getElementById('stop-name').value;
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const yandexMapUrl = document.getElementById('yandex-map-url').value;
            
            if (!name || !latitude || !longitude) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            if (zones.length === 0) {
                alert('–í—ã–¥–µ–ª–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–æ–Ω—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                return;
            }
            
            if (!selectedCamera) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É');
                return;
            }
            
            try {
                const stopData = {
                    name: name,
                    latitude: latitude,
                    longitude: longitude,
                    camera_id: selectedCamera.id,
                    yandex_map_url: yandexMapUrl || null,
                    stop_zone_coords: zones[0].coords, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∑–æ–Ω—É
                    original_resolution: {
                        width: canvas.width,
                        height: canvas.height
                    },
                    is_active: true
                };
                
                const response = await fetch(`${API_BASE}/admin/stops`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stopData)
                });
                
                if (response.ok) {
                    const stop = await response.json();
                    alert(`–û—Å—Ç–∞–Ω–æ–≤–∫–∞ "${stop.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('stop-name').value = '';
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    document.getElementById('yandex-map-url').value = '';
                    zones = [];
                    updateZonesDisplay();
                    redrawCanvas();
                } else {
                    const error = await response.json();
                    alert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
            }
        }
    </script>
</body>
</html>


