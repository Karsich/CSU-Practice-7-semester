<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта остановок - Мониторинг транспорта</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=471ae937-7015-43d8-a5f2-d9ab9505bf7b&lang=ru_RU" type="text/javascript"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .stop-popup {
            padding: 10px;
            min-width: 250px;
        }
        
        .stop-popup h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .stop-popup .info {
            margin: 5px 0;
        }
        
        .stop-popup .video-preview {
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            border-radius: 5px;
            background: #000;
        }
        
        .stop-popup canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .stop-popup .stats {
            display: flex;
            gap: 15px;
            margin: 10px 0;
        }
        
        .stop-popup .stat-item {
            text-align: center;
        }
        
        .stop-popup .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stop-popup .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .stop-popup .buses-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .stop-popup .bus-item {
            padding: 5px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 3px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let map;
        let stops = [];
        let cameraStreams = {}; // Хранилище WebSocket соединений для камер
        
        // Инициализация карты
        ymaps.ready(() => {
            map = new ymaps.Map('map', {
                center: [55.1644, 61.4368], // Челябинск
                zoom: 12
            });
            
            // Загрузка остановок
            loadStops();
        });
        
        // Загрузка списка остановок
        async function loadStops() {
            try {
                const response = await fetch(`${API_BASE}/passengers/stops`);
                stops = await response.json();
                
                // Добавление меток на карту
                stops.forEach(stop => {
                    if (stop.latitude && stop.longitude) {
                        addStopMarker(stop);
                    }
                });
            } catch (error) {
                console.error('Ошибка загрузки остановок:', error);
            }
        }
        
        // Добавление метки остановки
        function addStopMarker(stop) {
            const marker = new ymaps.Placemark(
                [stop.latitude, stop.longitude],
                {
                    balloonContentHeader: stop.name,
                    balloonContentBody: getStopPopupContent(stop),
                    balloonContentFooter: `<button onclick="openStopDetails(${stop.id})">Подробнее</button>`
                },
                {
                    preset: 'islands#blueCircleDotIcon',
                    iconColor: '#667eea'
                }
            );
            
            // При наведении показываем видео и статистику
            marker.events.add('mouseenter', () => {
                if (stop.camera_id) {
                    startCameraPreview(stop);
                }
                loadStopStats(stop.id, marker);
            });
            
            marker.events.add('mouseleave', () => {
                if (stop.camera_id) {
                    stopCameraPreview(stop.camera_id);
                }
            });
            
            map.geoObjects.add(marker);
        }
        
        // Получение содержимого попапа
        function getStopPopupContent(stop) {
            return `
                <div class="stop-popup">
                    <h3>${stop.name}</h3>
                    <div class="info">
                        <p><strong>Камера:</strong> ${stop.camera_id || 'Не указана'}</p>
                        <p><strong>Координаты:</strong> ${stop.latitude.toFixed(6)}, ${stop.longitude.toFixed(6)}</p>
                    </div>
                    <div class="video-preview" id="preview-${stop.id}">
                        <div class="loading">Загрузка видео...</div>
                    </div>
                    <div class="stats" id="stats-${stop.id}">
                        <div class="stat-item">
                            <div class="stat-value" id="people-${stop.id}">-</div>
                            <div class="stat-label">Люди</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="buses-${stop.id}">-</div>
                            <div class="stat-label">Автобусы</div>
                        </div>
                    </div>
                    <div class="buses-list" id="buses-${stop.id}">
                        <div class="loading">Загрузка автобусов...</div>
                    </div>
                </div>
            `;
        }
        
        // Запуск предпросмотра камеры
        function startCameraPreview(stop) {
            if (!stop.camera_id || cameraStreams[stop.camera_id]) {
                return; // Уже запущено
            }
            
            const previewContainer = document.getElementById(`preview-${stop.id}`);
            if (!previewContainer) return;
            
            // Создаем canvas для видео
            const canvas = document.createElement('canvas');
            canvas.id = `canvas-preview-${stop.id}`;
            previewContainer.innerHTML = '';
            previewContainer.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Подключаемся к WebSocket потоку
            const ws = new WebSocket(`ws://localhost:8000/api/v1/cv/camera/${stop.camera_id}/stream-ws?with_detection=true`);
            cameraStreams[stop.camera_id] = ws;
            
            ws.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    const img = new Image();
                    img.onload = () => {
                        // Устанавливаем оригинальное разрешение
                        if (stop.original_resolution) {
                            canvas.width = stop.original_resolution.width || img.width;
                            canvas.height = stop.original_resolution.height || img.height;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = URL.createObjectURL(event.data);
                } else {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.people_count !== undefined) {
                            document.getElementById(`people-${stop.id}`).textContent = data.people_count || 0;
                            document.getElementById(`buses-${stop.id}`).textContent = data.buses_count || 0;
                        }
                    } catch (e) {
                        // Игнорируем ошибки парсинга
                    }
                }
            };
            
            ws.onerror = (error) => {
                console.error(`Ошибка WebSocket для камеры ${stop.camera_id}:`, error);
                previewContainer.innerHTML = '<div class="loading">Ошибка подключения к камере</div>';
            };
        }
        
        // Остановка предпросмотра камеры
        function stopCameraPreview(cameraId) {
            if (cameraStreams[cameraId]) {
                cameraStreams[cameraId].close();
                delete cameraStreams[cameraId];
            }
        }
        
        // Загрузка статистики остановки
        async function loadStopStats(stopId, marker) {
            try {
                const response = await fetch(`${API_BASE}/passengers/current-load/${stopId}`);
                const data = await response.json();
                
                // Обновляем статистику в попапе
                const balloon = marker.balloon;
                if (balloon.isOpen()) {
                    document.getElementById(`people-${stopId}`).textContent = data.people_count || 0;
                    document.getElementById(`buses-${stopId}`).textContent = data.buses_detected || 0;
                    
                    // Загружаем список автобусов
                    loadBusesList(stopId, data.recent_buses || []);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }
        
        // Загрузка списка автобусов
        function loadBusesList(stopId, buses) {
            const container = document.getElementById(`buses-${stopId}`);
            if (!container) return;
            
            if (buses.length === 0) {
                container.innerHTML = '<div class="loading">Автобусы не обнаружены</div>';
                return;
            }
            
            container.innerHTML = buses.map(bus => `
                <div class="bus-item">
                    <strong>Автобус:</strong> ${bus.bus_number || 'Не распознан'}<br>
                    <small>Обнаружен: ${new Date(bus.detected_at).toLocaleTimeString()}</small>
                </div>
            `).join('');
        }
        
        // Открытие детальной информации об остановке
        function openStopDetails(stopId) {
            window.location.href = `cameras.html?stop=${stopId}`;
        }
        
        // Очистка при закрытии страницы
        window.onbeforeunload = () => {
            Object.values(cameraStreams).forEach(ws => {
                if (ws) ws.close();
            });
        };
    </script>
</body>
</html>

