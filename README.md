# Система мониторинга и прогнозирования загруженности общественного транспорта

## Описание

Система для оценки и прогнозирования загруженности общественного транспорта с использованием компьютерного зрения (YOLO). Система обрабатывает видеопотоки с камер, установленных на остановках, детектирует людей и автобусы, собирает данные о пассажиропотоке и строит прогнозы загруженности.

## Архитектура

Система построена на микросервисной архитектуре:

- **API Gateway** - единая точка входа (FastAPI)
- **Сервис компьютерного зрения** - обработка видеопотоков с помощью YOLO
- **Сервис прогнозирования** - построение прогнозов на основе Prophet
- **База данных** - PostgreSQL с расширением TimescaleDB для временных рядов
- **Redis** - кэширование и брокер сообщений для Celery
- **Frontend** - веб-интерфейс для пассажиров и аналитическая панель

## Технологический стек

### Backend
- Python 3.11
- FastAPI - веб-фреймворк
- YOLO (ultralytics) - детекция объектов
- OpenCV - обработка видео
- Prophet - прогнозирование временных рядов
- SQLAlchemy - ORM
- Celery - асинхронные задачи
- PostgreSQL + TimescaleDB - база данных
- Redis - кэш и брокер

### Frontend
- HTML/CSS/JavaScript
- Chart.js - визуализация данных

### DevOps
- Docker & Docker Compose
- Nginx - обратный прокси

## Установка и запуск

### Требования
- Docker и Docker Compose
- (Опционально) Python 3.11+ для локальной разработки

### Запуск через Docker Compose

1. Клонируйте репозиторий или скопируйте файлы проекта

2. Запустите все сервисы:
```bash
docker-compose up -d
```

3. Система будет доступна:
   - Frontend: http://localhost
   - API: http://localhost:8000
   - API документация: http://localhost:8000/docs

4. Для остановки:
```bash
docker-compose down
```

### Локальная разработка

1. Установите зависимости:
```bash
pip install -r backend/requirements.txt
```

2. Настройте переменные окружения (создайте `.env` файл):
```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/transport_db
REDIS_URL=redis://localhost:6379/0
CELERY_BROKER_URL=redis://localhost:6379/1
```

3. Запустите PostgreSQL и Redis

4. Создайте таблицы БД:
```bash
python -c "from backend.core.database import engine, Base; Base.metadata.create_all(bind=engine)"
```

5. Запустите API сервер:
```bash
cd backend
uvicorn main:app --reload
```

6. Запустите Celery worker:
```bash
celery -A tasks.celery_app worker --loglevel=info
```

## Использование

### API Endpoints

#### Для пассажиров:
- `GET /api/v1/passengers/current-load/{route_id}` - текущая загруженность
- `GET /api/v1/passengers/forecast/{route_id}` - прогноз загруженности
- `GET /api/v1/passengers/routes/{route_id}/stops` - остановки маршрута

#### Для аналитики:
- `GET /api/v1/analytics/load-statistics/{route_id}` - статистика загруженности
- `GET /api/v1/analytics/peak-hours/{route_id}` - часы пиковой загруженности

#### Компьютерное зрение:
- `POST /api/v1/cv/detect` - детекция объектов на изображении
- `POST /api/v1/cv/detect-with-visualization` - детекция с визуализацией
- `POST /api/v1/cv/process-frame/{stop_id}/{route_id}` - обработка кадра

#### Администрирование:
- `POST /api/v1/admin/routes` - создание маршрута
- `POST /api/v1/admin/stops` - создание остановки
- `POST /api/v1/admin/buses` - добавление автобуса

### Добавление тестовых данных

Для тестирования системы можно добавить данные через API:

```python
import requests

# Создание маршрута
route = requests.post("http://localhost:8000/api/v1/admin/routes", json={
    "number": "1",
    "name": "Маршрут №1",
    "description": "Тестовый маршрут",
    "is_active": True
})

# Создание остановки
stop = requests.post("http://localhost:8000/api/v1/admin/stops", json={
    "route_id": 1,
    "name": "Центральная остановка",
    "latitude": 55.1644,
    "longitude": 61.4368,
    "camera_url": "rtsp://example.com/stream",
    "is_active": True
})
```

## Особенности реализации

### Компьютерное зрение
- Используется предобученная модель YOLOv8 для детекции людей и автобусов
- Поддержка обработки видеопотоков в реальном времени
- Возможность распознавания номеров маршрутов (требует дополнительной настройки OCR)

### Прогнозирование
- Используется библиотека Prophet от Facebook для прогнозирования временных рядов
- Учитывается сезонность (дневная, недельная)
- Строятся прогнозы на 24 часа вперед

### База данных
- Использование TimescaleDB для эффективной работы с временными рядами
- Хранение данных о пассажиропотоке с временными метками
- Поддержка агрегированных запросов для аналитики

## Дальнейшее развитие

- [ ] Интеграция OCR для распознавания номеров маршрутов на автобусах
- [ ] Трекинг людей для точного подсчета посадок/высадок
- [ ] Интеграция с реальными камерами видеонаблюдения
- [ ] Мобильное приложение
- [ ] Улучшение алгоритмов прогнозирования (LSTM нейронные сети)
- [ ] Мониторинг и алертинг
- [ ] Расширенная аналитика и дашборды

## Лицензия

Проект разработан в рамках производственной практики.

## Автор

Разработано для ОГБУ «Челябинский региональный центр навигационно-информационных технологий»
